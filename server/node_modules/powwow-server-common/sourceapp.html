<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <title>Source Application</title>
</head>

<body>
    <div style="height:34px;width:1019px;">
        <span>Websocket URL:</span>
        <input id="wsurl" style="width:850px; height: 20px;" type="text" value="" onchange="setupWebSocket()">
    </div>
    <div style="border: 2px solid black;border-bottom:0px;height:34px;line-height:34px;padding-left:5px;width:1019px;">
        <span>URL:</span>
        <input id="sourceurl" style="width:750px; height: 20px;" type="text" disabled value="Loading...">
        <span><button onclick="refreshNow()">Refresh</button> Interval:</span>
        <select id="refreshInterval" style="width:90px;" onchange="updateRefreshTime()">
            <option value="0">None</option>
            <option value="500">1/2 second</option>
            <option value="1000" selected>1 second</option>
            <option value="2000">2 seconds</option>
            <option value="3000">3 seconds</option>
            <option value="4000">4 seconds</option>
            <option value="5000">5 seconds</option>
            <option value="10000">10 seconds</option>
            <option value="30000">30 seconds</option>
        </select>
    </div>
    <img style="border: 2px solid black;min-width: 1024px; min-height: 10px;" />
    <script>
        var img = document.querySelector('img');
        var input = document.querySelector('#sourceurl');
        var refreshTime = 1000;
        var getSnapshotTimer = null;
        var ws;

        function updateRefreshTime() {
            if (getSnapshotTimer) {
                clearTimeout(getSnapshotTimer);
                getSnapshotTimer = null;
            }
            if(ws && ws.onopen) {
                refreshTime = parseInt(document.querySelector("#refreshInterval").value);
                if(refreshTime) {
                    getSnapshotTimer = setTimeout(ws.onopen, refreshTime);
                }
            }
        }

        function refreshNow() {
            if(ws) {
                ws.send('{"jsonrpc":"2.0","method":".snapshot","params":{}}');
            }
        }

        function setupWebSocket() {
            var wsurl = document.querySelector('#wsurl').value;
            if(!wsurl) {
                wsurl = window.location.href.replace(/^http/, 'ws');
                document.querySelector('#wsurl').value = wsurl;
            }
            ws = new WebSocket(wsurl);
            ws.onopen = function (event) {
                refreshNow();
                if (ws.onopen) {
                    refreshTime = parseInt(document.querySelector("#refreshInterval").value);
                    if(refreshTime) {
                        getSnapshotTimer = setTimeout(ws.onopen, refreshTime);
                    }
                }
            };
            ws.onmessage = function (event) {
                var message = JSON.parse(event.data);
                img.src = 'data:image/png;base64,' + message.image;
                input.value = message.url;
            };
            ws.onclose = function (event) {
                if (getSnapshotTimer) {
                    clearTimeout(getSnapshotTimer);
                    getSnapshotTimer = null;
                }
                ws.onopen = null;
                ws.onmessage = null;
                ws.onclose = null;
                ws.onerror = null;
                ws.close();
                img.removeAttribute("src");
                // Try again in some time..
                input.value = "Server is down.  Trying to reconnect...";
                console.log();
                setTimeout(setupWebSocket, 3000);
            };
            ws.onerror = ws.onclose;
        }
        setupWebSocket();
    </script>
</body>

</html>
